# Results (entry description) for PHIP2 pose prediction
#
# This file will be automatically parsed.  It must contain the following seven elements:
# participant name, participant organization, name of method, software listing, method, method category, and ranked.
# These elements must be provided in the order shown.
# The file name must begin with the letters "PHIP2_2" and then be followed by an additional underscore or dash
# along with whatever characters you like, and end with ".txt"
#
# Please refer to https://github.com/samplchallenges/SAMPL7/blob/master/protein_ligand/README.md for a full
# description of how to format your submissions.
#
# FILE FORMAT: All comment lines in this file (which begin with #) will be ignored.
# Please use only UTF-8 characters in the non-comment fields. If your information (e.g. your name, etc.)
# contains a non-UTF-8 character, you may note it in comments near that entry.
#
#
# NOTE: Unlike the Stage 1 submission, this file does NOT provide your entries. Rather, it must be
# included in the .tar.gz file you upload which contains your submissions. Thus, no "predictions" section
# is required.

# PARTICIPANT INFORMATION SECTION
#
# Please list your name, using only UTF-8 characters as described above. The "Participant name:" entry is required.
Participant name:
Maciej Majewski

# Full list of contributors:
# Alejandro Varela 1, 2
# Maciej Majewski 2
# Alberto Cuzzolin 1
# Gerard Martinez 1
# Gianni De Fabritiis 1, 2, 3

#
# Please list your organization/affiliation, using only UTF-8 characters as described above.
Participant organization:
University Pompeu Fabra

# Full list of affiliations:
# 1. Acellera, Barcelona, Spain
# 2. Computational Science Laboratory, Universitat Pompeu Fabra, PRBB, Barcelona, Spain
# 3. Institucio Catalana de Recerca i Estudis Avancats (ICREA), Barcelona, Spain


# METHOD NAME SECTION
#
# Please provide a brief (40 character limit) informal yet informative name of the method used.
# Following is sample text; please edit to your taste.
# The "Name:" keyword is required, as shown here.
# 40 character limit.
Name:
CruptoScout


# SOFTWARE SECTION
#
# All major software packages used and their versions.
# Please use a new line for each software.
# Following is sample text; please edit to your taste.
# The "Software:" keyword is required.
Software:
rdkit 2018.03.4
HTMD
Playmolecule proteinPrepare, Paramatrize, CryptoScout
rDock
PyMol


# METHOD CATEGORY SECTION
#
# State which of the method category labels describe your prediction the best: `Docking`, `Ligand-based`, `MD`, `ML`, `Other`, `Null`.
# If your method takes advantage of multiple approaches please report more than one category label, separated by comma.
# `Docking` category refers to structure-based virtual screening methods that model the structure of the receptor binding pocket and pose of the ligand followed by an scoring the goodness of the fit .
# `Ligand-based` methods are virtual screening methods that do not rely on protein structure such as pharmacophore modeling, ligand shape-based, 2D or 3D structural similarity based methods.
# `MD` methods utilize molecular dynamics simulations based on molecular mechanics including free energy calculations.
# `ML` category includes machine learning, QSPR approaches, and all prediction methods trained on empirical knowledge.
# `Null` predictions employ a model which is not expected to produce useful predictions, however,  can provide a simple comparison point for more sophisticated methods, as ideally, good methods should outperform the null model.
# If these categories do not match your method, report as “Other”.
# If you choose the `Other` category, please explain your decision in the beginning of Method Description section.
# The `Category:` keyword is required.
Category:
MD, ML

# RANKING INFORMATION SECTION
#
# All submissions must either be ranked or non-ranked.
# Only one ranked submission per participant is allowed.
# Multiple ranked submissions from the same participant will not be judged.
# Non-ranked submissions are accepted so we can verify that they were made before the deadline.
# The "Ranked:" keyword is required, and expects a Boolean value (True/False)
Ranked:
False


# METHOD DESCRIPTION SECTION
#
# Methodology and computational details.
# Level of detail should be at least that used in a publication.
# Please include the values of key parameters, with units, and explain how any
# statistical uncertainties were estimated.
# Use as many lines of text as you need.
# Please explicitly describe how you handle ions (e.g. counterions) and pKa effects
# Following is sample text; please edit to your taste.
# All text following the "Method:" keyword will be regarded as part of your free text methods description.
Method:
Apo structure was prepared at pH 5.8 with proteinPrepare app at playmolecule.com.

Ligands tautomers and protomers possible at the pH 5.8 were enumerated and if the stereochemistry of chiral ligand was not defined in SMILES stereoisomers were also enumerated. Generated 3D conformers were then curated manually using our best medicinal chemistry knowledge. In case multiple mers for a ligand were selected, each one of them was processed individually and the results were combined at the end.

Next the ligands were parameterized using Paramtrize app at playmolecule.com

Next molecular dynamics was performed using CryptoScout app at playmolecule.com. CruptoScout is a molecular dynamics simulation, where unrestrained protein is simulated in a box with solvent and fragment of interest (concentration of fragment was set to 0.1M which translates to ~50 fragments in the simulation). For each ligand the simulation was repeated 10 times and each MD lasted 40 ns. 

After the simulations finished the results were analysed using HTMD. The trajectories were aligned by pocket residues (selection = 'resid 23 to 49 or resid 75 to 94', which is equivalent to 'resid 1336 to 1362 or resid 1388 to 1405' in reference file PHIPA_C2_Apo.pdb provided by organisers.

Then for trajectories of all ligands we computed maps of distances between heavy atoms of ligands and CA atoms of four representative pocket residues (‘resid 27 33 40 79’) using HTMD projections: moleculekit.projections.metricdistance.MetricDistance 

Then based on the calculated distance maps we selected only the ligands that were located in the pocket of interest with a mean distance to key residues lower than 10 A.

Extracted poses were then clustered into 10 clusters based on the distances from key residues using sklearn.cluster.MiniBatchKMeans 

The clusters were then sorted based on the population and the most occupied cluster was selected as the top1 pose and 5 most populated clusters were selected as top 5 poses. As a final pose we selected the frame that was the closest to the centroid of a cluster.

Selected frame was finally aligned to a reference frame by the pocket residues and split into an SDF file with ligand and PDB file with protein conformation. 


For the following codes two mers were simulated:

F179, F229, F501, F687

Each of two mers for those ligands were simulated and processed individually and then top pose nad top5 posed were selected based on the population of clusters in each simulation. 


List of simulated ligands:

F126
F14
F179
F217
F229
F275
F362
F366
F367
F368
F369
F374
F389
F393
F421
F467
F488
F501
F529
F535
F558
F584
F603
F616
F618
F650
F666
F687
F710
F760
F95
F96

The rest was substituted by docking 
